<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad Change - PickToCart</title>
<style type="text/css">
*{
padding: 0;
margin: 0;
}
.header {
  position: fixed;
  top: 0;
  left: 0;
  width: 98%;
  background: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding:3px;
  border-bottom: 1px solid #eee;
  height:70px;
  z-index: 1000;
}
#image-preview {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
  margin-top: 20px;
  border: 1px solid #ddd;
}

.image1 {
  margin-top: 100px;
  text-align: center;
  border: 2px solid #eee;
  width: 90%;
  margin-left: 5px;
  border-radius: 10px;
  padding: 10px;
  background-color: #f9f9f9;
}

.image1 h3 {
  font-weight: bold;
  font-size: 20px;
  margin-bottom: 10px;
}

#adOne {
  margin-top: 15px;
  display: flex;
  gap: 20px;
  justify-content: center;
}

#submit {
  width: 70px;
  padding: 7px;
  background-color: #FF3636;
  border: none;
  font-weight: bold;
  border-radius: 4px;
  color: #FFF;
  cursor: pointer;
}

#submit:hover {
  background-color: #FF5252;
}
a{
text-decoration:none;
color:#000;
}
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 40px;
}

.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: #00356E;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>
</head>

<body>
<div class="header">
<p id="name"><b>PickToCart - Ad Center</b></p>
<p id="home"><a href="dashboard.html" >Dashboard</a></p>
</div>

<div class="loading" id="loading-spinner">
  <div class="spinner"></div>
</div>

<div class="image1" id="content" style="display: none;">
  <h3><b>Front Page ad</b></h3>
<form id="adOne">
  <input type="file" id="file">
  <button id="submit">Submit</button>
</form>
&nbsp;

<img id="recent-image" src="" alt="Recent" style="width: 100%; height: 200px; object-fit: cover; border-radius: 10px;">
</div>
</body>
</html>
<script type="module">
import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
const supabaseUrl = 'https://wtiqgcsucpcqgyqutcmq.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0aXFnY3N1Y3BjcWd5cXV0Y21xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MzMzNDYsImV4cCI6MjA2MjAwOTM0Nn0.MtXBQ9qXTPwWEBh8l5jYh_zDYKkYyiUc2WwaA5wrtpE';
const supabase = createClient(supabaseUrl, supabaseKey);

// Authentication check
async function checkAuth() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) {
        window.location.href = 'login.html';
        return null;
    }
    return user;
}

// Initialize page
document.addEventListener('DOMContentLoaded', async function() {
    const user = await checkAuth();
    if (!user) return;
    
    // Show content after auth check
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('content').style.display = 'block';
    
    const form = document.getElementById('adOne');
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const avatarFile = document.getElementById("file").files[0];
        if (!avatarFile) {
            alert("Please add a file");
            return;
        }
        
        try {
            const { data: { user }, error: authError } = await supabase.auth.getUser();
            if (authError) throw authError;
            if (!user) {
                alert("You must be logged in to upload an image");
                window.location.href = '/login.html';
                return;
            }
            
            const { data, error } = await supabase
                .storage
                .from('secure_images')
                .upload(`${user.id}_${avatarFile.name}`, avatarFile, {
                    cacheControl: '3600',
                    upsert: false,
                });
            if (error) throw error;
            
            const { data: publicUrlData } = supabase
                .storage
                .from('secure_images')
                .getPublicUrl(`${user.id}_${avatarFile.name}`);
            const imageUrl = publicUrlData.publicUrl;
            
            const { data: userData, error: userError } = await supabase
                .from('usernames')
                .select('name, surname')
                .eq('user_id', user.id);
            if (userError) throw userError;
            
            const name = userData[0].name;
            const surname = userData[0].surname;
            
            const { data: insertData, error: insertError } = await supabase
                .from('secure_images')
                .insert([
                    {
                        user_id: user.id,
                        name: name,
                        surname: surname,
                        image1: imageUrl,
                    },
                ]);
            if (insertError) throw insertError;
            
            alert('Image uploaded successfully');
            
            const { data: recentData, error: recentError } = await supabase
                .from('secure_images')
                .select('image1')
                .eq('user_id', user.id)
                .order('id', { ascending: false })
                .limit(1);
            if (recentError) throw recentError;
            
            if (recentData.length > 0) {
                const recentImageUrl = recentData[0].image1;
                const recentImage = document.getElementById('recent-image');
                recentImage.src = recentImageUrl;
            }
        } catch (error) {
            alert('Error uploading image: ' + error.message);
        }
    });

    // Load recent image on page load
    try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        const { data, error } = await supabase
            .from('secure_images')
            .select('image1')
            .eq('user_id', user.id)
            .order('id', { ascending: false })
            .limit(1);
        if (error) throw error;
        
        if (data.length > 0) {
            const imageUrl = data[0].image1;
            const recentImage = document.getElementById('recent-image');
            recentImage.src = imageUrl;
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>