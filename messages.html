<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages Dashboard - PickToCart</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #00356E 0%, #0059B3 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            transition: background 0.3s;
        }

        .header a:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            text-align: center;
        }

        .stats-card h2 {
            color: #00356E;
            margin-bottom: 10px;
            font-size: 22px;
        }

        .stats-card p {
            font-size: 18px;
            color: #666;
        }

        .section-title {
            color: #00356E;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 22px;
        }

        /* Message Container Styles */
        .message-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 4px solid #00356E;
            position: relative;
        }

        .message-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .message-container.processed {
            border-left-color: #28a745;
            opacity: 0.85;
        }

        .message-container.old {
            border-left-color: #6c757d;
            opacity: 0.7;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .message-id {
            background: #00356E;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .message-name {
            font-size: 18px;
            font-weight: 600;
            color: #00356E;
        }

        .message-email {
            color: #666;
            margin: 5px 0;
            font-size: 15px;
        }

        .message-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 15px;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }

        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .message-date {
            color: #888;
            font-size: 14px;
        }

        .message-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-confirm {
            background-color: #28a745;
            color: white;
        }

        .btn-confirm:hover {
            background-color: #218838;
        }

        .btn-confirm.confirmed {
            background-color: #6c757d;
            cursor: default;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .btn-bulk {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-bulk:hover {
            background-color: #e0a800;
        }

        .btn-archive {
            background-color: #6f42c1;
            color: white;
        }

        .btn-archive:hover {
            background-color: #5a2d91;
        }

        /* Bulk Actions */
        .bulk-actions {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .bulk-actions.active {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .select-all {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ccc;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #888;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #00356E;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Checkbox for bulk actions */
        .message-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 18px;
            height: 18px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: #00356E;
            color: white;
        }

        .page-btn:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }

        .page-info {
            margin: 0 15px;
            color: #666;
        }

        @media (max-width: 768px) {
            .message-header, .message-footer {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .message-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }

            .control-panel {
                flex-direction: column;
                align-items: flex-start;
            }

            .filter-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-envelope"></i> PickToCart - Messages Dashboard</h1>
        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Back to Dashboard</a>
    </div>

    <div class="dashboard-container">
        <div class="loading" id="loading-spinner">
            <div class="spinner"></div>
        </div>

        <div id="content" style="display: none;">
            <!-- Control Panel -->
            <div class="control-panel">
                <div class="filter-controls">
                    <select class="filter-select" id="status-filter">
                        <option value="all">All Messages</option>
                        <option value="new">New Messages</option>
                        <option value="processed">Processed Messages</option>
                        <option value="old">Old Messages (30+ days)</option>
                    </select>
                    
                    <select class="filter-select" id="sort-filter">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>

                <div class="bulk-controls">
                    <button class="btn btn-bulk" id="bulk-select-btn">
                        <i class="fas fa-check-square"></i> Select Multiple
                    </button>
                    <button class="btn btn-archive" id="archive-old-btn">
                        <i class="fas fa-archive"></i> Archive Old Messages
                    </button>
                </div>
            </div>

            <!-- Bulk Actions Panel -->
            <div class="bulk-actions" id="bulk-actions">
                <div class="select-all">
                    <input type="checkbox" id="select-all-checkbox">
                    <label for="select-all-checkbox">Select All</label>
                </div>
                <span id="selected-count">0 messages selected</span>
                <button class="btn btn-confirm" id="bulk-process-btn">
                    <i class="fas fa-check"></i> Mark as Processed
                </button>
                <button class="btn btn-delete" id="bulk-delete-btn">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
                <button class="btn btn-secondary" id="cancel-bulk-btn">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>

            <div class="stats-card">
                <h2 id="number">Total Messages: 0</h2>
                <p id="storage-info">Manage and organize your customer inquiries</p>
            </div>

            <h2 class="section-title"><i class="fas fa-inbox"></i> Customer Messages</h2>
            <div id="messages-output" class="output"></div>

            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none;">
                <button class="page-btn" id="prev-page" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="page-info" id="page-info">Page 1 of 1</span>
                <button class="page-btn" id="next-page" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
        const supabaseUrl = 'https://wtiqgcsucpcqgyqutcmq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind0aXFnY3N1Y3BjcWd5cXV0Y21xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MzMzNDYsImV4cCI6MjA2MjAwOTM0Nn0.MtXBQ9qXTPwWEBh8l5jYh_zDYKkYyiUc2WwaA5wrtpE';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // Authentication check
        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error || !user) {
                window.location.href = 'login.html';
                return null;
            }
            return user;
        }

        // Global variables for message management
        let allMessages = [];
        let currentPage = 1;
        const messagesPerPage = 10;
        let bulkSelectMode = false;
        let selectedMessages = new Set();

        const checkUserSession = async () => {
            console.log("checkUserSession function executed");
            
            // Check authentication first
            const user = await checkAuth();
            if (!user) return;
            
            try {
                const { data, error, count } = await supabase
                    .from('user_data')
                    .select('Id, name, email, date, message, status')
                    .order('date', { ascending: false });

                if (error) throw error;
                
                allMessages = data || [];
                
                const postNo = "Total Messages: " + allMessages.length;
                document.getElementById("number").innerText = postNo;

                // Calculate storage info
                const totalSize = calculateTotalSize(allMessages);
                const oldMessagesCount = allMessages.filter(msg => isMessageOld(msg.date)).length;
                
                document.getElementById("storage-info").innerHTML = 
                    `Storage: ${totalSize} | Old messages (30+ days): ${oldMessagesCount}`;

                applyFiltersAndDisplay();

            } catch (error) {
                console.error("Error:", error.message);
            }
        };

        // Calculate approximate total size of messages
        function calculateTotalSize(messages) {
            let totalBytes = 0;
            messages.forEach(msg => {
                // Rough estimate: each character ≈ 1 byte, plus metadata
                totalBytes += (msg.name?.length || 0) + 
                             (msg.email?.length || 0) + 
                             (msg.message?.length || 0) + 100; // +100 for metadata
            });
            
            if (totalBytes < 1024) {
                return totalBytes + ' bytes';
            } else if (totalBytes < 1048576) {
                return (totalBytes / 1024).toFixed(2) + ' KB';
            } else {
                return (totalBytes / 1048576).toFixed(2) + ' MB';
            }
        }

        // Check if message is old (30+ days)
        function isMessageOld(dateString) {
            const messageDate = new Date(dateString);
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            return messageDate < thirtyDaysAgo;
        }

        // Apply filters and display messages
        function applyFiltersAndDisplay() {
            const statusFilter = document.getElementById('status-filter').value;
            const sortOrder = document.getElementById('sort-filter').value;
            
            let filteredMessages = [...allMessages];
            
            // Apply status filter
            if (statusFilter === 'new') {
                filteredMessages = filteredMessages.filter(msg => !msg.status);
            } else if (statusFilter === 'processed') {
                filteredMessages = filteredMessages.filter(msg => msg.status);
            } else if (statusFilter === 'old') {
                filteredMessages = filteredMessages.filter(msg => isMessageOld(msg.date));
            }
            
            // Apply sort order
            if (sortOrder === 'oldest') {
                filteredMessages.sort((a, b) => new Date(a.date) - new Date(b.date));
            } else {
                filteredMessages.sort((a, b) => new Date(b.date) - new Date(a.date));
            }
            
            displayMessages(filteredMessages);
            setupPagination(filteredMessages);
        }

        // Display messages with pagination
        function displayMessages(messages = null) {
            const messagesToDisplay = messages || getCurrentPageMessages();
            const outputElement = document.getElementById('messages-output');
            outputElement.innerHTML = '';
            
            if (messagesToDisplay.length === 0) {
                outputElement.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <h3>No messages found</h3>
                        <p>No messages match your current filters</p>
                    </div>
                `;
                return;
            }

            messagesToDisplay.forEach((userData) => {
                const messageDiv = createMessageElement(userData);
                outputElement.appendChild(messageDiv);
            });
        }

        // Get messages for current page
        function getCurrentPageMessages() {
            const startIndex = (currentPage - 1) * messagesPerPage;
            const endIndex = startIndex + messagesPerPage;
            return allMessages.slice(startIndex, endIndex);
        }

        // Setup pagination
        function setupPagination(messages) {
            const totalPages = Math.ceil(messages.length / messagesPerPage);
            const paginationElement = document.getElementById('pagination');
            const pageInfoElement = document.getElementById('page-info');
            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            
            if (totalPages <= 1) {
                paginationElement.style.display = 'none';
                return;
            }
            
            paginationElement.style.display = 'flex';
            pageInfoElement.textContent = `Page ${currentPage} of ${totalPages}`;
            
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        }

        function createMessageElement(userData) {
            const messageDiv = document.createElement('div');
            const isProcessed = userData.status;
            const isOld = isMessageOld(userData.date);
            
            messageDiv.classList.add('message-container');
            if (isProcessed) messageDiv.classList.add('processed');
            if (isOld) messageDiv.classList.add('old');
            
            // Add checkbox for bulk selection if in bulk mode
            const checkboxHtml = bulkSelectMode ? 
                `<input type="checkbox" class="message-checkbox" data-id="${userData.Id}" onchange="toggleMessageSelection(${userData.Id})">` 
                : '';
            
            messageDiv.innerHTML = `
                ${checkboxHtml}
                <div class="message-header">
                    <span class="message-name">${userData.name}</span>
                    <span class="message-id">ID: #${userData.Id}</span>
                </div>
                <div class="message-email">
                    <i class="fas fa-envelope"></i> ${userData.email}
                </div>
                <div class="message-content">
                    ${userData.message}
                </div>
                <div class="message-footer">
                    <span class="message-date">
                        <i class="far fa-clock"></i> ${new Date(userData.date).toLocaleString()}
                        ${isOld ? ' <span style="color: #dc3545;">(Old)</span>' : ''}
                    </span>
                    <div class="message-actions">
                        <button class="btn btn-confirm ${userData.status ? 'confirmed' : ''}" 
                                data-request-id="${userData.Id}" 
                                onclick="toggleEmailSent(${userData.Id}, ${userData.status || false})">
                            <i class="fas ${userData.status ? 'fa-check' : 'fa-paper-plane'}"></i>
                            ${userData.status ? 'Processed' : 'Mark Processed'}
                        </button>
                        <button class="btn btn-delete" 
                                data-request-id="${userData.Id}" 
                                onclick="deleteRequest(${userData.Id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
            return messageDiv;
        }

        // Bulk selection functions
        function toggleBulkSelectMode() {
            bulkSelectMode = !bulkSelectMode;
            selectedMessages.clear();
            
            const bulkActions = document.getElementById('bulk-actions');
            const bulkSelectBtn = document.getElementById('bulk-select-btn');
            
            if (bulkSelectMode) {
                bulkActions.classList.add('active');
                bulkSelectBtn.innerHTML = '<i class="fas fa-times"></i> Cancel Selection';
                bulkSelectBtn.classList.add('btn-secondary');
            } else {
                bulkActions.classList.remove('active');
                bulkSelectBtn.innerHTML = '<i class="fas fa-check-square"></i> Select Multiple';
                bulkSelectBtn.classList.remove('btn-secondary');
                document.getElementById('selected-count').textContent = '0 messages selected';
            }
            
            displayMessages();
        }

        function toggleMessageSelection(messageId) {
            if (selectedMessages.has(messageId)) {
                selectedMessages.delete(messageId);
            } else {
                selectedMessages.add(messageId);
            }
            
            updateSelectedCount();
        }

        function selectAllMessages() {
            const checkboxes = document.querySelectorAll('.message-checkbox');
            const selectAll = document.getElementById('select-all-checkbox').checked;
            
            if (selectAll) {
                checkboxes.forEach(checkbox => {
                    const messageId = parseInt(checkbox.getAttribute('data-id'));
                    selectedMessages.add(messageId);
                    checkbox.checked = true;
                });
            } else {
                selectedMessages.clear();
                checkboxes.forEach(checkbox => checkbox.checked = false);
            }
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = 
                `${selectedMessages.size} message${selectedMessages.size !== 1 ? 's' : ''} selected`;
        }

        // Bulk actions
        async function bulkProcessMessages() {
            if (selectedMessages.size === 0) {
                alert('Please select messages to process');
                return;
            }
            
            if (!confirm(`Mark ${selectedMessages.size} message${selectedMessages.size !== 1 ? 's' : ''} as processed?`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_data')
                    .update({ status: true })
                    .in('Id', Array.from(selectedMessages));
                    
                if (error) throw error;
                
                alert(`${selectedMessages.size} message${selectedMessages.size !== 1 ? 's' : ''} marked as processed`);
                toggleBulkSelectMode();
                checkUserSession();
            } catch (error) {
                console.error('Error processing messages:', error);
                alert('Error processing messages');
            }
        }

        async function bulkDeleteMessages() {
            if (selectedMessages.size === 0) {
                alert('Please select messages to delete');
                return;
            }
            
            if (!confirm(`Permanently delete ${selectedMessages.size} message${selectedMessages.size !== 1 ? 's' : ''}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('user_data')
                    .delete()
                    .in('Id', Array.from(selectedMessages));
                    
                if (error) throw error;
                
                alert(`${selectedMessages.size} message${selectedMessages.size !== 1 ? 's' : ''} deleted successfully`);
                toggleBulkSelectMode();
                checkUserSession();
            } catch (error) {
                console.error('Error deleting messages:', error);
                alert('Error deleting messages');
            }
        }

        // Archive old messages (delete messages older than 30 days)
        async function archiveOldMessages() {
            const oldMessages = allMessages.filter(msg => isMessageOld(msg.date));
            
            if (oldMessages.length === 0) {
                alert('No old messages found to archive');
                return;
            }
            
            if (!confirm(`Archive ${oldMessages.length} old message${oldMessages.length !== 1 ? 's' : ''} (older than 30 days)? This will permanently delete them.`)) {
                return;
            }
            
            try {
                const oldMessageIds = oldMessages.map(msg => msg.Id);
                const { error } = await supabase
                    .from('user_data')
                    .delete()
                    .in('Id', oldMessageIds);
                    
                if (error) throw error;
                
                alert(`${oldMessages.length} old message${oldMessages.length !== 1 ? 's' : ''} archived successfully`);
                checkUserSession();
            } catch (error) {
                console.error('Error archiving old messages:', error);
                alert('Error archiving old messages');
            }
        }

        // Individual message functions
        async function toggleEmailSent(requestId, isEmailSent) {
            const newStatus = !isEmailSent;
            const { error } = await supabase
                .from('user_data')
                .update({ status: newStatus })
                .eq('Id', requestId);
            if (error) {
                console.error('Error updating email sent status:', error);
                alert('Failed to update email status.');
            } else {
                checkUserSession();
            }
        }

        async function deleteRequest(requestId) {
            if (confirm('Are you sure you want to delete this message?')) {
                const { error } = await supabase
                    .from('user_data')
                    .delete()
                    .eq('Id', requestId);
                if (error) {
                    console.error('Error deleting message:', error);
                    alert('Failed to delete message.');
                } else {
                    checkUserSession();
                }
            }
        }

        // Pagination functions
        function goToPage(page) {
            currentPage = page;
            displayMessages();
            setupPagination(allMessages);
        }

        function nextPage() {
            if (currentPage < Math.ceil(allMessages.length / messagesPerPage)) {
                goToPage(currentPage + 1);
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication first
            const user = await checkAuth();
            if (!user) return;
            
            // Hide loading and show content
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            
            // Load messages
            checkUserSession();
            
            // Event listeners for filters
            document.getElementById('status-filter').addEventListener('change', applyFiltersAndDisplay);
            document.getElementById('sort-filter').addEventListener('change', applyFiltersAndDisplay);
            
            // Bulk action event listeners
            document.getElementById('bulk-select-btn').addEventListener('click', toggleBulkSelectMode);
            document.getElementById('select-all-checkbox').addEventListener('change', selectAllMessages);
            document.getElementById('bulk-process-btn').addEventListener('click', bulkProcessMessages);
            document.getElementById('bulk-delete-btn').addEventListener('click', bulkDeleteMessages);
            document.getElementById('cancel-bulk-btn').addEventListener('click', toggleBulkSelectMode);
            document.getElementById('archive-old-btn').addEventListener('click', archiveOldMessages);
            
            // Pagination event listeners
            document.getElementById('next-page').addEventListener('click', nextPage);
            document.getElementById('prev-page').addEventListener('click', prevPage);
        });

        // Make functions globally available
        window.toggleEmailSent = toggleEmailSent;
        window.deleteRequest = deleteRequest;
        window.toggleMessageSelection = toggleMessageSelection;
    </script>
</body>
</html>